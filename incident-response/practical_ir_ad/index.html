<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6E5Q6YSW8D"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-6E5Q6YSW8D');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/retype">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.806941934751">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Practical Incident Response - Active Directory</title>
    <meta name="title" content="Practical Incident Response - Active Directory">
    <meta name="description" content="Hello everyone! It’s been a while since my last blog post. This time, I wanted to make a blog on simulating Incident Response in an Active Directory...">

    <!-- Canonical -->
    <link rel="canonical" href="https://nxb1t.github.io/retype/incident-response/practical_ir_ad/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nxb1t.github.io/retype/incident-response/practical_ir_ad/">
    <meta property="og:title" content="Practical Incident Response - Active Directory">
    <meta property="og:description" content="Hello everyone! It’s been a while since my last blog post. This time, I wanted to make a blog on simulating Incident Response in an Active Directory...">
    <meta property="og:image" content="https://nxb1t.github.io/retype/assets/img/ad_ir/npp1.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://nxb1t.github.io/retype/incident-response/practical_ir_ad/">
    <meta property="twitter:title" content="Practical Incident Response - Active Directory">
    <meta property="twitter:description" content="Hello everyone! It’s been a while since my last blog post. This time, I wanted to make a blog on simulating Incident Response in an Active Directory...">
    <meta property="twitter:image" content="https://nxb1t.github.io/retype/assets/img/ad_ir/npp1.png">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../favicon.ico" rel="icon">
    <link href="../../resources/css/retype.css?v=3.11.0.806941934751" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.11.0.806941934751" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.11.0.806941934751" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../resources/js/prism.js?v=3.11.0.806941934751" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">nxb1t</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">is-a.dev</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://nxb1t.neocities.org" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M8.75 7a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5ZM7 11.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75ZM9.75 15a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z"></path><path d="M2 3.75C2 2.784 2.784 2 3.75 2h16.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 20.25 22H3.75A1.75 1.75 0 0 1 2 20.25Zm1.75-.25a.25.25 0 0 0-.25.25v16.5c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25V3.75a.25.25 0 0 0-.25-.25Z"></path>
                                        </g>
                                    </svg>
                                    <span>CTF Writeups</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/nxb1t" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                        </g>
                                    </svg>
                                    <span>GitHub</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://www.linkedin.com/in/nashid-p-694842226" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                        </g>
                                    </svg>
                                    <span>LinkedIn</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-tex font-header-text-weight hover:text-header-text-hover" href="https://infosec.exchange/@nxb1t" target="_blank">
                                    <img class="mb-px mr-1" width="18" alt="" src="https://img.icons8.com/external-tal-revivo-color-tal-revivo/24/null/external-mastodon-is-an-online-self-hosted-social-media-and-social-networking-service-logo-color-tal-revivo.png">
                                    <span>Mastodon</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://twitter.com/nxb1t4n6" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-.139 9.237c.209 4.617-3.234 9.765-9.33 9.765-1.854 0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.08-4.03 3.199-4.03.943 0 1.797.398 2.395 1.037.748-.147 1.451-.42 2.086-.796-.246.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.439.656-.996 1.234-1.639 1.697z"/>
                                        </g>
                                    </svg>
                                    <span>Twitter</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://nxb1t.neocities.org" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M8.75 7a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5ZM7 11.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75ZM9.75 15a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z"></path><path d="M2 3.75C2 2.784 2.784 2 3.75 2h16.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 20.25 22H3.75A1.75 1.75 0 0 1 2 20.25Zm1.75-.25a.25.25 0 0 0-.25.25v16.5c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25V3.75a.25.25 0 0 0-.25-.25Z"></path>
                                                </g>
                                            </svg>
                                            <span>CTF Writeups</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/nxb1t" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                                </g>
                                            </svg>
                                            <span>GitHub</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://www.linkedin.com/in/nashid-p-694842226" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                                </g>
                                            </svg>
                                            <span>LinkedIn</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-tex font-header-text-weight hover:text-header-text-hover" href="https://infosec.exchange/@nxb1t" target="_blank">
                                            <img class="mb-px mr-1" width="18" alt="" src="https://img.icons8.com/external-tal-revivo-color-tal-revivo/24/null/external-mastodon-is-an-online-self-hosted-social-media-and-social-networking-service-logo-color-tal-revivo.png">
                                            <span>Mastodon</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://twitter.com/nxb1t4n6" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-.139 9.237c.209 4.617-3.234 9.765-9.33 9.765-1.854 0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.08-4.03 3.199-4.03.943 0 1.797.398 2.395 1.037.748-.147 1.451-.42 2.086-.796-.246.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.439.656-.996 1.234-1.639 1.697z"/>
                                                </g>
                                            </svg>
                                            <span>Twitter</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="practical-incident-response---active-directory" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#practical-incident-response---active-directory">#</doc-anchor-trigger>
        <span>Practical Incident Response - Active Directory</span>
    </h1>
</doc-anchor-target>
<div class="-mt-3 mb-12 flex flex-wrap text-sm text-gray-400 dark:text-dark-350 items-center print:justify-center">
    <div class="flex items-center">
        <div>By</div>
        <div class="ml-2 flex items-center">
          <div class="shrink-0 w-8 h-8 overflow-hidden rounded-full">
            <img class="object-cover" src="https://nxb1t.is-a.dev/assets/img/profile.jpeg">
          </div>
          <div class="ml-1 whitespace-nowrap text-gray-500 dark:text-dark-350">nxb1t</div>
        </div>
    </div>
    <div class="mx-2">&#9679;</div>
    <div>In&nbsp;</div>
    <div><a href="../../categories/active-directory/">Active Directory</a>,&nbsp;</div>
    <div><a href="../../categories/digital-forensics/">Digital Forensics</a>,&nbsp;</div>
    <div><a href="../../categories/incident-response/">Incident Response</a>,&nbsp;</div>
    <div><a href="../../categories/threat-hunting/">Threat Hunting</a></div>
    <div class="mx-2">&#9679;</div>
    <div class="flex items-center shrink-0">Published&nbsp;<span>2024-09-21</span></div>
</div>

<doc-anchor-target id="introduction">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#introduction">#</doc-anchor-trigger>
        <span>Introduction</span>
    </h2>
</doc-anchor-target>
<p>Hello everyone! It’s been a while since my last blog post.<br>
This time, I wanted to make a blog on simulating Incident Response in an Active Directory environment by doing some common attack scenarios, so we can get some basic level of practical experience around this area. While I am not an expert in Incident Response, I have some basic knowledge and also really passionate about this field. Here I won&#x27;t be showing how I carried out the attack simulation, I will leave it for you guys to explore on your own :).</p>
<p>Before continuing, please checkout the following link to setup the AD Lab used in this blog, The lab&#x27;s theme is centered around a hypothetical tech company named <strong>XOPS</strong> :</p>
<p>
<div class="mb-6 px-5 py-4 flex justify-between relative border border-base-border hover:border-base-border-hover rounded transition-colors duration-150">
    <div class="flex items-center text-base-500">
        <span class="inline-block mb-px">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" role="presentation" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z"/></svg>
        </span>
        <span class="inline-block font-medium ml-2">Active Directory Home Lab</span>
    </div>
    <div class="flex items-center text-xs text-gray-400 dark:text-dark-400">
        <span>https://nxb1t.is-a.dev/lab-setups/ad_lab/</span>
    </div>
    <a href="https://nxb1t.is-a.dev/lab-setups/ad_lab/" class="absolute block inset-0"></a>
</div>
</p>
<p><strong>Ok, What is Incident Response ?</strong> <br>
Incident response is a structured process organizations use to detect and respond to cyber threats, security breaches, and other unexpected events. The goal of incident response is to minimize damage, reduce recovery time and costs, and restore operations. There are various models for incident response lifecycle, such as PICERL, a six-step framework, and the more modern DAIR. In our blog, we will use the DAIR (Dynamic Approach to Incident Response) model, which is a five-step, continuous approach.</p>
<ol>
<li>Preparation - Implementing security policies.</li>
<li>Detect - Continuously monitoring security events.</li>
<li>Verify and Triage - Quickly verifying security incidents and performing analysis.</li>
<li>Scope, Contain, Eradicate, Recover, Remediate - Identifying affected areas, containing threats, eradicating them, and conducting recovery.</li>
<li>Lessons Learned - Learning from incidents and using threat intelligence to improve security controls and prevent new threats.</li>
</ol>
<p>You can learn more on DAIR from <a href="https://medium.com/@cyberengage.org/rethinking-incident-response-from-picerl-to-dair-7b153a76e044">here</a>.</p>
<p>The preparation phase of DAIR is done while we setup the AD Lab. The remaining phases are done when the incident happened.</p>
<p>There are multiple job roles for Incident Response :-</p>
<ul>
<li>A <strong>Security Engineer</strong> takes care of maintaining security infrastructure</li>
<li>A <strong>Security Analyst L1</strong> monitors alerts and performs initial triage</li>
<li>A <strong>Security Analyst L2</strong> analyzes incidents and conducts threat hunting</li>
<li>A <strong>Security Analyst L3</strong> investigates complex incidents and leads response efforts</li>
</ul>
<p>We are kind of doing the jobs of all roles in this blog :D.</p>
<hr>
<doc-anchor-target id="the-incident">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#the-incident">#</doc-anchor-trigger>
        <span>The Incident</span>
    </h2>
</doc-anchor-target>
<p>XOPS, a leading player in the software market, recently fell victim to a ransomware attack. The company had only recently introduced a SOC team and had basic security configurations in place. Unfortunately, the attacker bypassed these tools and managed to compromise multiple systems. The initial entry point was a malicious software download by one of XOPS’ employees. The employee intended to download a portable version of Notepad++ from Google but was redirected to a malicious site due to search engine poisoning.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/npp1.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>The employee only realized the infection when they noticed a ransom note on their system.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/note.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>When he saw the ransom note, he quickly reported it to the relevant stakeholders. As a Security Analyst, we are assigned to evaluate, hunt and remediate the threat.</p>
<hr>
<doc-anchor-target id="the-response">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#the-response">#</doc-anchor-trigger>
        <span>The Response</span>
    </h2>
</doc-anchor-target>
<p>Since there were no alerts raised by any of the security controls, we need to start from the beginning by examining the logs, analyzing the downloaded file and so on.</p>
<p>The tools we will use as part of threat hunting are :-</p>
<ul>
<li>Elastic SIEM</li>
<li>FTK Imager</li>
<li>Volatility</li>
<li>Loki</li>
<li>CAPA</li>
<li>IDA</li>
<li>x64dbg</li>
<li>Fakenet-NG</li>
<li>dnSpy</li>
</ul>
<p>The employee informed us of the specific package they downloaded and executed, which pointed us towards Notepad++. Using this information, we began our hunt by focusing on activities associated with Notepad++.</p>
<doc-anchor-target id="log-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#log-analysis">#</doc-anchor-trigger>
        <span>Log Analysis</span>
    </h3>
</doc-anchor-target>
<p>Based on the initial information, we identified two key events related to the Notepad++ package in the event logs : the first one was a FileCreate event (<strong>ID - 11</strong>), indicating the package was saved on the system, and the second was a Process Creation event (<strong>ID - 1</strong>), showing that the application was executed.</p>
<p>We can see the file creation event have a <code v-pre>notepad++.lnk</code> shortcut file being saved, which is really unusual for a portable program.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/initial_vector.png" alt="Searching Notepad++" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Searching Notepad++</figcaption>
</figure>
</p>
<p>Focusing on the Process Creation event (<strong>ID - 1</strong>), we observed details such as the process name, arguments, and parent process information. The process name and parent process stood out in this context, indicating unusual activity. Specifically, the process name didn&#x27;t align with typical Notepad++ behavior (npp.dll), and the parent process (cmd.exe) was not one usually associated with launching a legitimate application like Notepad++.</p>
<p>However the npp.dll is actually notepad++.exe and the attacker renamed it for crafting an attack path based on the shortcut file.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">/**  pe.original_file_name is a metadata showing the original file name during compile time **/

host.name : &quot;c1&quot; and winlog.event_id: &quot;1&quot; and process.pe.original_file_name: &quot;notepad++.exe&quot;</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/initial_vector_2.png" alt="Notepad++ Process Creation" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Notepad++ Process Creation</figcaption>
</figure>
</p>
<p>By examining the cmd process, we noticed an interesting command line associated with it. The parent process was Powershell, and its command line revealed that it was fetching a file from an external website and executing it in hidden mode.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/initial_vector_3.png" alt="Parent Process Commandline" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Parent Process Commandline</figcaption>
</figure>
</p>
<p>We can leverage the timeline feature in Kibana (<strong>Security --&gt; Timelines --&gt; Create New Timeline</strong>) to gain a broader understanding of the PowerShell process. By reviewing the timeline, we can piece together related events and activities surrounding the PowerShell execution, such as subsequent actions, and interactions with other processes or network connections.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/process_timeline.png" alt="Creating Timeline" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Creating Timeline</figcaption>
</figure>
</p>
<p>Using the analyzer feature, we were able to view all the child process created by the Powershell process.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/process_timeline_2.png" alt="Using Process Analyzer" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Using Process Analyzer</figcaption>
</figure>
</p>
<p>We noticed a process named <code v-pre>Registry.exe</code> spawning numerous child process. Additionally, the process name mimics the legitimate Windows process Registry. We obtained the process&#x27;s SHA-256 hash: <code v-pre>ac18ceefb605f3b87c5becb64a2320bc1cfa2c97345cc1abd9efb62fee8ffc2c</code>, which will be useful for IOCs.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/initial_hash.png" alt="Loader Process Hash" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Loader Process Hash</figcaption>
</figure>
</p>
<p>We can see the commandline arguments of all child process spawned by the malicious Registry process, indicating that certain enumerations like ip lookup, user lookup and querying ssh information being conducted.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/child_process.png" alt="Process Commandline Arguements" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Process Commandline Arguements</figcaption>
</figure>
</p>
<p>While examining the network connections created by the malicious process, we noticed connections to the same IP address from which the executable was downloaded, but on an HTTPS port, indicating a potential C&amp;C connection. Connections on port 8080 likely correspond to staged payloads. Additionally, we observed connections to LDAP initiated by the same process.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/networking_ips.png" alt="Network Connections Initiated by the Process" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Network Connections Initiated by the Process</figcaption>
</figure>
</p>
<p>We will start by examining the LDAP queries. By focusing on the time range from the first LDAP request to the last made by the process, we can isolate several queries. Among these, the first and second queries stand out. Notably, the second query is associated with the Kerberoasting technique, which is used to retrieve all Service Principal Names (SPNs) and their associated accounts.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/ldap_search.png" alt="LDAP Queries" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">LDAP Queries</figcaption>
</figure>
</p>
<p>Looking for any service tickets Requested (<strong>ID - 4769</strong>) for any user in the same timeframe as the ldap queries, we can see one event stands out for username <code v-pre>bkp_op</code>. Kerberoasting tools like Rubeus by default request service tickets using RC4 (0x17) encryption, which is weak and easy to bruteforce. Moreover, the Ticket Options is also unique compared to legitimate ticket requests.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">winlog.event_id:&quot;4769&quot; and winlog.event_data.TicketEncryptionType:&quot;0x17&quot; and winlog.event_data.TicketOptions: &quot;0x40800000&quot; or winlog.event_data.TicketOptions: &quot;0x40810010&quot;</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/kerberoast.png" alt="Weak Kerberoast Service Ticket Request" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Weak Kerberoast Service Ticket Request</figcaption>
</figure>
</p>
<p>Looking back to network connections, we can see a connection to ssh. Which indicates the attacker likely used pivoting to access the internal network of the compromised machine.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/beacon_ssh.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>We also recall the attacker querying PuTTY&#x27;s <code v-pre>SshHostKeys</code>, which might have been an attempt to identify SSH sessions that could be used for lateral movement. Additionally, we observed a new login from the bkp_op user, indicating further escalation within the network.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/ssh_login.png" alt="SSH Logins" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">SSH Logins</figcaption>
</figure>
</p>
<p>We had the /tmp/ folder under monitoring with auditd, so using that filter, we can see all programs executed from it. The attacker used evil-winrm from the /tmp/ folder, indicating an attempt to access other machines within the network.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/ssh_evilwinrm.png" alt="Execution of Evil-WinRM" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Execution of Evil-WinRM</figcaption>
</figure>
</p>
<p>Based on the timeline of the evil-winrm execution, we reviewed the logon events related to the bkp_op user to verify if any lateral movement from the compromised Ubuntu server had occurred.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/winrm_logon.png" alt="Network Login Events related to bkp_op User" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Network Login Events related to bkp_op User</figcaption>
</figure>
</p>
<p>To gain a better understanding, we correlated logon events with process creation on the C2 machine. This approach helped us map out the activities and interactions between logins and processes, providing clearer insights into any lateral movement or further exploitation that occurred.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">sequence
[authentication where winlog.event_id == &quot;4624&quot; and winlog.event_data.TargetUserName == &quot;bkp_op&quot;]
[process where host.name == &quot;c2&quot; and winlog.event_id == &quot;1&quot; and user.name: &quot;bkp_op&quot;]</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/correlation.png" alt="Correlating Logon Events with Process Creation" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Correlating Logon Events with Process Creation</figcaption>
</figure>
</p>
<p>We observed the creation of the process <code v-pre>wsmprovhost.exe</code>, which indicates the establishment of a WinRM session on the host. The subsequent process chain reveals the dropping of another loader, suggesting that the attacker continued their activities by deploying additional malicious tools.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/correlation_process.png" alt="Checking Child Process of Second Loader using Analyzer" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Checking Child Process of Second Loader using Analyzer</figcaption>
</figure>
</p>
<p>The attacker used the same loader but modified its name. The hash of both loaders are identical: <code v-pre>ac18ceefb605f3b87c5becb64a2320bc1cfa2c97345cc1abd9efb62fee8ffc2c</code></p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/c2_beacon_hash.png" alt="Second loader hash" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Second loader hash</figcaption>
</figure>
</p>
<p>The <code v-pre>bkp_op</code> user is part of Backup Operators group which gives him SeBackupPrivilege, this privilege can bypass all ACLs and allow the user to read most of the System files. The attacker leveraged this privilege and dumped the SYSTEM and SAM registry hives.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/process_commandlines.png" alt="Commandline Arguements of Child Process" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Commandline Arguements of Child Process</figcaption>
</figure>
</p>
<p>After that, we didn&#x27;t see any telemetry from the C2 machine towards the Domain Controller or any other systems, suggesting that the attacker was unable to escalate further. We also checked the DC logs and didn&#x27;t saw anything unusual.</p>
<p>Additionally, we didn&#x27;t find any data related to the creation of the ransom note.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/missing_events.png" alt="Missing Events related to Ransom Note" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Missing Events related to Ransom Note</figcaption>
</figure>
</p>
<doc-anchor-target id="memory-forensics">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#memory-forensics">#</doc-anchor-trigger>
        <span>Memory Forensics</span>
    </h3>
</doc-anchor-target>
<p>Through log analysis, we were able to understand the attacker&#x27;s path, the TTPs they used, and the network-level IOCs. To identify the tools used and, in particular, to decrypt the ransomware-encrypted files, we need to analyze the memory of the loader process. After isolating the client machines we took memory dump, the ubuntu machine didn&#x27;t had anything unusual running.</p>
<p>Using volatility3 we can look at the modules loaded by the loader process, in it the <code v-pre>clr.dll</code> really stands out. clr.dll only comes in context of a program either if its a .NET application or it explicitly loads clr.dll to interact with CLR runtime.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_loadedmodules.png" alt="Loaded Modules" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Loaded Modules</figcaption>
</figure>
</p>
<p>Based on the previous analysis we can assume its a C2 beacon as many C2 frameworks utilize CLR for inline-execution of .NET assemblies to avoid security controls. We can utilize the Volatility <code v-pre>windows.vadyarascan</code> module to scan memory regions to identify any known C2 framework shellcode. If no known signatures are found, additional analysis of the sample will be required. In our case, the yara rule for Havoc C2 got a match.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_yara.png" alt="Havoc yara rule match" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Havoc yara rule match</figcaption>
</figure>
</p>
<p>To get more detailed information about Havoc payload, like agent id and encryption keys, we can use a volatility <a href="https://github.com/Immersive-Labs-Sec/HavocC2-Forensics/blob/main/Volatility/havoc.py">plugin</a> created by ImmersiveLabs. If we were caputing network packets we could utilise this information to decrypt them and get more insight on the C2 communictaions, anyway in our lab we were&#x27;t capturing network packets.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_havoc_meta.png" alt="Havoc agent details" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Havoc agent details</figcaption>
</figure>
</p>
<p>Since its Havoc C2, it is high likely the attacker utilizing inline-execution function to execute .NET programs based on our previous finding about clr.dll. If that&#x27;s the case, then those programs could stay in memory and we can extract them by dumping the loader&#x27;s process memory.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_procdump.png" alt="Dump loader process memory" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Dump loader process memory</figcaption>
</figure>
</p>
<p>Here we used the Foremost tool to extract the executable files.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_foremost.png" alt="Extracted executables from the process memory" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Extracted executables from the process memory</figcaption>
</figure>
</p>
<p>Scanning those files using loki showed the presence of SharpSploit related files.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_lokiscan.png" alt="Scanning for malicious files using Loki tool" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Scanning for malicious files using Loki tool</figcaption>
</figure>
</p>
<p>Some files weren&#x27;t detected by loki indicating its not a known malicious file, we can analyse them further during the Malware Analysis time.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/mem_susfile.png" alt="Suspicious .NET executable" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Suspicious .NET executable</figcaption>
</figure>
</p>
<p>The memory dump from C2 Machine didn&#x27;t had any new tactics or techniques and were almost similar.</p>
<doc-anchor-target id="host-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#host-analysis">#</doc-anchor-trigger>
        <span>Host Analysis</span>
    </h3>
</doc-anchor-target>
<p>While analyzing the logs, we didn&#x27;t observe any persistence techniques used by the threat actor on any of the Windows machines. We also manually checked for backdoors in the autorun directory and other common locations, but found nothing. However, our Ubuntu machine had the least telemetry, so we need to check if any persistence mechanisms were added on that host.</p>
<p>From the logs, we verified that the attacker did not escalate to higher privileges, as the <code v-pre>bkp_op</code> user was not in the sudoers group. Upon examining the <code v-pre>.bashrc</code> file, we found an interesting entry pointing to another .bashrc file in the .local directory.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/persis_bashrc.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>Upon checking, it turned out to be a Bash reverse shell.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/persis_bashrc2.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<doc-anchor-target id="malware-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#malware-analysis">#</doc-anchor-trigger>
        <span>Malware Analysis</span>
    </h3>
</doc-anchor-target>
<p>We need to thoroughly analyze the loader and its associated files. From the YARA scan we previously conducted, we identified some of the executables, including SharpChrome and SharpUp, as well as another executable with no known signature. We will analyse the loader and the files extracted from memory which weren&#x27;t detected based known signatures in a sandbox environment.</p>
<p>Starting with the loader, we can use <code v-pre>capa</code> tool to assess its capabilities. While we observed many features, not all of them may be true positives. But this gives us an high level overview of the loader&#x27;s capabilities. Capa also showed that this loader is a rust compiled binary.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_capa.png" alt="Checking loader Capabilities using CAPA" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Checking loader Capabilities using CAPA</figcaption>
</figure>
</p>
<p>The RC4 match was PRGA.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_capa2.png" alt="RC4 Encryption Match" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">RC4 Encryption Match</figcaption>
</figure>
</p>
<p>We can use IDA for static analysis of the binary. In the main function we found a function related to VEH (Vectored Exception Handling), which can be employed to evade Endpoint Security Controls.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader.png" alt="Loader Main Function in IDA" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Loader Main Function in IDA</figcaption>
</figure>
</p>
<p>We discovered a function that loads amsi.dll and looks for function AmsiScanBuffer, further down it also had function looking for NtTraceControl. But there weren&#x27;t any patching signs, so since its using VEH this has to be a patchless approach by setting up exception at function entry.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader2.png" alt="Function utilizing AMSI bypass" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Function utilizing AMSI bypass</figcaption>
</figure>
</p>
<p>NtGetThreadContext and NtSetThreadContext function calls were also seen, which are used to set hardware breakpoints.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader5.png" alt="Using NtGetThreadContext and NtSetThreadContext" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Using NtGetThreadContext and NtSetThreadContext</figcaption>
</figure>
</p>
<p>Going further, we encountered an interesting string. Its been processed inside a loop with range 256 which sort of correlates with CAPA result of RC4 encryption.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader3.png" alt="Interesting string found" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Interesting string found</figcaption>
</figure>
</p>
<p>We created a dummy .NET program named reg and hosted it in our localhost using fakenet-ng. By redirecting traffic to localhost, we conducted dynamic analysis using x64dbg. We can see the hardware breakpoints being created at AmsiScanBuffer and NtTraceControl using NtSetThreadContext API, the address of the AmsiScanBuffer and NtTraceControl can be seen at Dr0 and Dr1 registers, this is done initially before loading the staged payload to evade security controls.</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-primary"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-primary" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>Note</h5>
<p>While i was using the exe version of fakenet-ng, I encountered an error (Error 87) which prevented the request redirecting to localhost.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/fakenet-issue.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>So I had to run fakenet-ng as a python module and implementing the fix as mentioned in the github issue <a href="https://github.com/mandiant/flare-fakenet-ng/issues/173">here</a>.</p>
<p><code v-pre>python -m fakenet.fakenet</code></p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/fakenet-fix.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
        </div>
    </div>
</div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader7.png" alt="Hardware Breakpoints at AmsiScanBuffer and NtTraceControl" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Hardware Breakpoints at AmsiScanBuffer and NtTraceControl</figcaption>
</figure>
</p>
<p>After fetching the staged payload <code v-pre>reg</code>, the loader seems to do decryption using the <code v-pre>0xdeadbeef</code> string. Because we couldn&#x27;t find any traces of our dummy program in-memory, which means the dummy program became gibberish due to the decryption operation.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader4.png" alt="Key for RC4 Decryption" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Key for RC4 Decryption</figcaption>
</figure>
</p>
<p>Once the payload is decrypted, the loader creates a new CLR instance effectively executing the .NET assembly in-memory.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_loader6.png" alt="CLR Mechanism in loader" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">CLR Mechanism in loader</figcaption>
</figure>
</p>
<p>After analyzing the loader, we examined the suspicious binary extracted from memory, which turned out to be a .NET executable. By decompiling it with dnSpy, we confirmed that it was the ransomware responsible for encrypting files. The ransomware used RC4 encryption and the encryption key was visible in the binary. With this key, we were able to decrypt the encrypted files.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/rev_susfiledecomp.png" alt="Decompiling the extracted binary from memory" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Decompiling the extracted binary from memory</figcaption>
</figure>
</p>
<doc-anchor-target id="attack-overview">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#attack-overview">#</doc-anchor-trigger>
        <span>Attack Overview</span>
    </h3>
</doc-anchor-target>
<p>After conducting a thorough analysis of the endpoints, we were able to piece together the entire attack path and TTPs used. The attacker choose to deliver malware via malicious shortcut file, this is a widely used technique by Threat Actors, especially in malware campaigns like Qakbot.</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-primary"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-primary" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>Note</h5>
<p>Timeline is really important in Incident Response, since the blog have became queit long i have skipped that part, but you can check <a href="https://www.cybertriage.com/glossary-term/timeline-analysis-for-incident-response/">here</a> to learn more on that topic.</p>
        </div>
    </div>
</div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/attack_path.png" alt="Attack Path Diagram" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Attack Path Diagram</figcaption>
</figure>
</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Tactic</th>
<th>Technique used</th>
<th>Technique ID</th>
<th>Tools used</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial Access</td>
<td>Drive-by Compromise (Malvertising)</td>
<td>T1189</td>
<td>-</td>
</tr>
<tr>
<td>Execution</td>
<td>Malicious File (Shortcut File) , Command and Scripting Interpreter (Powershell)</td>
<td>T1204.002, T1059.001</td>
<td>-</td>
</tr>
<tr>
<td>Defense Evasion</td>
<td>Indicator Blocking (Etw and AMSI Patching)</td>
<td>T1562.006</td>
<td>Rust Loader</td>
</tr>
<tr>
<td>Command and Control</td>
<td>Web Protocol  (Using HTTPS as C2 channel)</td>
<td>T1071.001</td>
<td>Havoc C2</td>
</tr>
<tr>
<td>Discovery</td>
<td>Remote Discovery (Querying Domain Joined Computers)</td>
<td>T1018</td>
<td>ldapsearch</td>
</tr>
<tr>
<td>Credential Access</td>
<td>Kerberoasting, Credential From Web Browsers</td>
<td>T1558.003, T1555.003</td>
<td>Rubeus, SharpChrome</td>
</tr>
<tr>
<td>Lateral Movement</td>
<td>SSH, Windows Remote Management</td>
<td>T1021.004, T1021.006</td>
<td>SSH, EvilWinRM</td>
</tr>
<tr>
<td>Persistence</td>
<td>Unix Shell Modification</td>
<td>T1546.004</td>
<td>Bash Reverse Shell</td>
</tr>
<tr>
<td>Impact</td>
<td>Data Encrypted For Impact</td>
<td>T1486</td>
<td>.NET based Ransomware</td>
</tr>
</tbody>
</table>
</div>
<doc-anchor-target id="detection-engineering">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detection-engineering">#</doc-anchor-trigger>
        <span>Detection Engineering</span>
    </h3>
</doc-anchor-target>
<p>From this incident, we gained valuable insights, such as the need for a proper alerting mechanism, better password policies, and other improvements. In this section, we will focus on creating alert rules and policies to ensure timely detection and response to similar attacks in the future.</p>
<doc-anchor-target id="detecting-clr-loader">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detecting-clr-loader">#</doc-anchor-trigger>
        <span>Detecting CLR Loader</span>
    </h4>
</doc-anchor-target>
<p>While analyzing the loader&#x27;s memory, we found an indicator that may suggest the execution of .NET assemblies in memory: the presence of CLR DLLs, the loader was written in rust so no way it loads clr.dll by default. So by tweaking our sysmon config we can add more visibility on module loading and detect if any malicious beacons are running in our system.</p>
<p>The given rule is a basic one that logs when <code v-pre>clr.dll</code> is loaded by any process, excluding those running from the Windows directory. As a result, even if a normal .NET application is run, it will be logged. This may lead to false positives, but with proper correlation, we can identify potential CLR loaders and inline execution of .NET assemblies.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">&lt;!--SYSMON EVENT ID 7 : DLL (IMAGE) LOADED BY PROCESS [ImageLoad]--&gt;
&lt;!--COMMENT:	Can cause high system load, disabled by default.--&gt;
&lt;!--COMMENT:	[ https://attack.mitre.org/wiki/Technique/T1073 ] [ https://attack.mitre.org/wiki/Technique/T1038 ] [ https://attack.mitre.org/wiki/Technique/T1034 ] --&gt;

&lt;!--DATA: UtcTime, ProcessGuid, ProcessId, Image, ImageLoaded, Hashes, Signed, Signature, SignatureStatus--&gt;
&lt;RuleGroup name=&quot;Detect CLR DLLs being loaded by process&quot; groupRelation=&quot;or&quot;&gt;
    &lt;ImageLoad onmatch=&quot;include&quot;&gt;
        &lt;ImageLoaded condition=&quot;is&quot;&gt;C:\Windows\Microsoft.NET\Framework\v4.0.30319\clr.dll&lt;/ImageLoaded&gt;
	    &lt;ImageLoaded condition=&quot;is&quot;&gt;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\clr.dll&lt;/ImageLoaded&gt;
    &lt;/ImageLoad&gt;
&lt;/RuleGroup&gt;
&lt;RuleGroup name=&quot;&quot; groupRelation=&quot;or&quot;&gt;
    &lt;ImageLoad onmatch=&quot;exclude&quot;&gt;
        &lt;Image condition=&quot;contains&quot;&gt;C:\Windows\&lt;/Image&gt;
    &lt;/ImageLoad&gt;
&lt;/RuleGroup&gt;</code></pre>
</doc-codeblock></div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">sysmon64 -c .\sysmonconfig-export.xml</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_clr_pwsh.png" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>After manually updating the Sysmon configuration on the client machines, I re-ran the loader, and we can now observe the loading of <code v-pre>clr.dll</code> by the Registry process.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_clr.png" alt="Detecting CLR Dlls Loaded By the Loader" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Detecting CLR Dlls Loaded By the Loader</figcaption>
</figure>
</p>
<p>To quickly detect the loader if someone downloads it again, we need to create a YARA rule based on the indicators of compromise (IOCs) identified during malware analysis. These IOCs include unique strings, imported functions, and techniques such as setting hardware breakpoints at <code v-pre>AmsiScanBuffer</code> and <code v-pre>NtTraceControl</code>. Using this information, we can craft a YARA rule for this specific sample.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">rust_veh_loader.yar</div>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">rule rust_veh_loader {
        meta:
                author = &quot;nxb1t&quot;
                description = &quot;Detects rust based loaders utilizing VEH&quot;
                os = &quot;windows&quot;
        strings:
                $a1 = { 0F 85 ?? 01 00 00 80 3D ?? 15 10 00 01 75 ?? 48 8B ?? ?? 15 10 00 }
                $a2 = &quot;AddVectoredExceptionHandler&quot;
                $a3 = &quot;rustc&quot;
                $a4 = &quot;NtGetContextThread&quot;
                $a5 = &quot;NtSetContextThread&quot;
                $a6 = &quot;NtTraceControl&quot;
                $a7 = &quot;AmsiScanBuffer&quot;
        condition:
                $a1 and $a2 and $a3 and 1 of ($a4,$a5,$a6,$a7)
}</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_loki.png" alt="Yara rule working as Intended" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Yara rule working as Intended</figcaption>
</figure>
</p>
<doc-anchor-target id="detecting-kerberoasting">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detecting-kerberoasting">#</doc-anchor-trigger>
        <span>Detecting Kerberoasting</span>
    </h4>
</doc-anchor-target>
<p>Kerberoasting is a very serious security issue we need to continuosly monitor. During log analysis, we detected kerberoasting attempts, based on the queries we can create an alert rule to quickly notify us in case of any potential Kerberoasting attempt.</p>
<p>We can create new alert rules in Elastic SIEM by going to <strong>Security --&gt; Rules --&gt; Create new rule</strong>.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_alert.png" alt="Elastic SIEM Rules" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Elastic SIEM Rules</figcaption>
</figure>
</p>
<p>Add the name of rule , description and severity. We can additionally add MITRE TTP and on what integrations this rule depends on , what are the false positive and so on.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_alert2.png" alt="Creating New Alert Rule" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Creating New Alert Rule</figcaption>
</figure>
</p>
<p>This is the correlation rule we developed to detect Kerberoasting attacks in our lab&#x27;s context. Whether through inline execution or network pivoting, when a beacon attempts Kerberoasting, it will establish a Kerberos connection on port 88. By correlating this with any weak TGT requests and considering ticket options used by tools like Rubeus and Impacket-GetUserSPNs, we can detect these attacks in a timely manner. However, if the attack originates from a compromised Linux system, we would need to create a separate rule that focuses solely on Service Ticket Requests without correlating to any specific process.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">sequence by source.ip
      [network where winlog.event_id == &quot;3&quot; 
       and destination.port == &quot;88&quot;
       and not process.executable == &quot;C:\\Windows\\system32\\lsass.exe&quot;]
      [authentication where winlog.event_id == &quot;4769&quot; 
       and winlog.event_data.TicketEncryptionType == &quot;0x17&quot; 
       and (winlog.event_data.TicketOptions == &quot;0x40800000&quot; or winlog.event_data.TicketOptions == &quot;0x40810010&quot;)]</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_alert1.png" alt="Adding Rule Query" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Adding Rule Query</figcaption>
</figure>
</p>
<p>We can add connectors for instant notifications when the rule is triggered, in our case I selected none.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_alert3.png" alt="Adding Action Connectors" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Adding Action Connectors</figcaption>
</figure>
</p>
<p>Here I am repeating the kerberoasting attack by pivoting to internal network and using Impacket-GetUserSPNs.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_pivot.png" alt="Kerberoasting using Impacket" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Kerberoasting using Impacket</figcaption>
</figure>
</p>
<p>As you can see, our rule successfully triggered when the attack was conducted.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_alert4.png" alt="Alert Triggered" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Alert Triggered</figcaption>
</figure>
</p>
<p>Investigating the alert on timeline give more details about the events took place.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_kerb_timeline.png" alt="Detailed View Of Alert" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Detailed View Of Alert</figcaption>
</figure>
</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-primary"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-primary" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>Note</h5>
<p>What if the attacker only searched for SPN accounts without proceeding with Kerberoasting?<br>
This is where LDAP query monitoring becomes useful. By creating an alert for potentially malicious LDAP queries based on event log <code v-pre>1644</code>, we can detect the presence of malicious actors early on. Additionally, incorporating deception techniques, such as a decoy user with an attached SPN, can help detect potential Kerberoasting attempts while minimizing false positives.</p>
        </div>
    </div>
</div>
<doc-anchor-target id="detecting-browser-credential-stealing">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detecting-browser-credential-stealing">#</doc-anchor-trigger>
        <span>Detecting Browser Credential Stealing</span>
    </h4>
</doc-anchor-target>
<p>Credential theft is a serious issue that we must actively defend against. If compromised credentials belong to high-privileged users in cloud or other infrastructures, it significantly increases the attack surface and potential damage to our organization. During our Memory Forensics Analysis, one of the executables we extracted from the process memory was SharpChrome, which abuses the DPAPI (Windows Data Protection API) to list all saved passwords in Chromium-based browsers.</p>
<p><strong>Netero1010</strong> has beautifully explained detection strategies in his <a href="https://www.netero1010-securitylab.com/detection/browser-credential-stealing-detection">blog</a>, He utilizes File Object Access auditing for detecting these type of attacks.</p>
<p>One detection blindspot he mentioned was utilizing process injection. In that case, the credential-stealing activity would appear to originate from the legitimate browser process.</p>
<p>So, Let&#x27;s simulate the blindspot scenario of injecting shellcode into chrome process and running SharpChrome from there.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_shellinj.png" alt="Remote Process Injection" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Remote Process Injection</figcaption>
</figure>
</p>
<p>Shellcode successfully injected into chrome process (PID - <strong>5764</strong>) and we ran the SharpChrome with the dotnet inline-execute method.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_chrome.png" alt="Executing SharpChrome from the Injected Process" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Executing SharpChrome from the Injected Process</figcaption>
</figure>
</p>
<p>When we check the Chrome processes in Process Hacker, we can see that one Chrome process (PID - <strong>5764</strong>) is highlighted in green, indicating that it has .NET assemblies loaded.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_chrome_proc.png" alt="Chrome Process List" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Chrome Process List</figcaption>
</figure>
</p>
<p>When we check event ID <strong>4663</strong>, we can see that the injected Chrome process has accessed the <code v-pre>Login Data</code> and <code v-pre>Local State</code> files, which at first glance may appear to be legitimate activity.</p>
<p>In the generated event, process id is shown in hex format, thats why I entered <code v-pre>0x1684</code> in query which equals to <code v-pre>5764</code>.</p>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_chrome_ls.png" alt="File Object Access Event" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">File Object Access Event</figcaption>
</figure>
</p>
<p>As a detection strategy for this blindspot, we can correlate the file object access event with the Sysmon rule we created earlier.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">sequence
[process where winlog.event_id == &quot;7&quot; and rule.name == &quot;Detect CLR DLLs being loaded by process&quot;]
[any where winlog.event_id == &quot;4663&quot; and winlog.event_data.SubjectUserName == &quot;adam&quot;]</code></pre>
</doc-codeblock></div>
<p><figure class="content-center">
    <img src="../../assets/img/ad_ir/detect_chrome_byp.png" alt="Correlation of Events" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption">Correlation of Events</figcaption>
</figure>
</p>
<doc-anchor-target id="detecting-evil-winrm">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detecting-evil-winrm">#</doc-anchor-trigger>
        <span>Detecting Evil WinRM</span>
    </h4>
</doc-anchor-target>
<p>For detecting the use of Evil-WinRM we can either utilize the strategies like correlating the process creation and login event</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">query</div>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">sequence
[authentication where winlog.event_id == &quot;4624&quot; and winlog.event_data.TargetUserName == &quot;bkp_op&quot;]
[process where host.name == &quot;c2&quot; and winlog.event_id == &quot;1&quot; and user.name: &quot;bkp_op&quot;]</code></pre>
</doc-codeblock></div>
<p>or I found a nice <a href="https://medium.com/@cY83rR0H1t/evil-winrm-detection-de2874af7eb0">blog</a> by cY83rR0H1t with even better approach using event ids <code v-pre>4103</code> and <code v-pre>800</code>.</p>
<doc-anchor-target id="detecting-linux-persistence-mechanisms">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#detecting-linux-persistence-mechanisms">#</doc-anchor-trigger>
        <span>Detecting Linux Persistence Mechanisms</span>
    </h4>
</doc-anchor-target>
<p>Checkout Elastic Security&#x27;s <a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms">Primer on Persistence Mechanisms</a> for a detailed walkthrough on detecting persistence mechanisms and linux detection engineering.</p>
<hr>
<doc-anchor-target id="conclusion">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#conclusion">#</doc-anchor-trigger>
        <span>Conclusion</span>
    </h2>
</doc-anchor-target>
<p>Through this blog i hope you guys got a basic understanding of practical steps in Incident Response. In an enterprise scenario the logs would be huge and without proper threat hunting and detection engineering skillset it would be hard to find the threats and contain them on time with minimal impact.</p>
<doc-anchor-target id="references">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#references">#</doc-anchor-trigger>
        <span>References</span>
    </h2>
</doc-anchor-target>
<ul>
<li><a href="https://www.intrinsec.com/kerberos_opsec_part_1_kerberoasting/">Intrinsec - Kerberos OPSEC</a></li>
<li><a href="https://www.varonis.com/blog/guide-no-hassle-eql-threat-hunting">No Hassle Guide to EQL for Threat Hunting</a></li>
<li><a href="https://www.immersivelabs.com/blog/havoc-c2-framework-a-defensive-operators-guide/">ImmersiveLabs - Havoc C2 Defensive Operators Guide</a></li>
<li><a href="https://www.mdsec.co.uk/2020/06/detecting-and-advancing-in-memory-net-tradecraft/">MDSec - Detecting and Advancing In-Memory .NET Tradecraft</a></li>
<li><a href="https://www.youtube.com/@jstrosch">Dr Josh Stroschein - The Cyber Yeti</a></li>
<li><a href="https://www.youtube.com/@CyberAttackDefense">Cyber Attack &amp; Defense</a></li>
<li><a href="https://www.youtube.com/@rot169/videos">Attack Detect Defend</a></li>
</ul>

                                <div id="retype-tags" class="flex items-center mt-6 mb-6 clear-both">
                                    <span>
                                        <a href="../../tags/">
                                            <svg class="inline-block -mb-px mr-1.5 text-body-link hover:text-body-link-hover" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" overflow="visible" fill="currentColor"><g><path d="M21.3 9.88l-8.59-8.59C12.52 1.11 12.27 1 12 1H2c-.55 0-1 .45-1 1v10c0 .27.11.52.29.71l8.59 8.58c.57.57 1.32.88 2.12.88s1.55-.31 2.12-.88l7.17-7.17a3.009 3.009 0 00.01-4.24zm-1.42 2.82l-7.17 7.17c-.39.39-1.02.39-1.42 0L3 11.59V3h8.59l8.29 8.29c.39.39.39 1.03 0 1.41z" /><path d="M7.01 6C6.45 6 6 6.45 6 7s.45 1 1 1 1-.45 1-1-.44-1-.99-1z" /></g></svg>
                                        </a>
                                        <span class="mr-2"><a href="../../tags/active-directory/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-badge-info-text bg-badge-info border border-badge-info-border hover:text-badge-info-text-hover hover:bg-badge-info-hover hover:border-badge-info-border-hover transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>active directory</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/digital-forensics/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-badge-info-text bg-badge-info border border-badge-info-border hover:text-badge-info-text-hover hover:bg-badge-info-hover hover:border-badge-info-border-hover transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>digital forensics</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/incident-response/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-badge-info-text bg-badge-info border border-badge-info-border hover:text-badge-info-text-hover hover:bg-badge-info-hover hover:border-badge-info-border-hover transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>incident response</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/threat-hunting/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-badge-info-text bg-badge-info border border-badge-info-border hover:text-badge-info-text-hover hover:bg-badge-info-hover hover:border-badge-info-border-hover transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>threat hunting</span>
                                </a></span>
                                    </span>
                                </div>
                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../digital-forensics/android_forensics/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">Android Forensics - An Introduction</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../lab-setups/ad_lab/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">Active Directory Lab</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© 2025 - <a href="https://nxb1t.is-a.dev">nxb1t.is-a.dev</a> - All rights reserved</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Practical Incident Response - Active Directory", level: 2, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
